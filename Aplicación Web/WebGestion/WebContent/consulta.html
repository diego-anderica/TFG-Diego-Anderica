<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		
		<!-- BootStrap v4.0 -->
 		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
 		<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
		<!-- BootStrap v4.0 -->
		
		<!-- Firebase -->
		<script src="https://www.gstatic.com/firebasejs/4.11.0/firebase.js"></script>
		<script src="https://www.gstatic.com/firebasejs/4.11.0/firebase-firestore.js"></script>
		<!-- Firebase -->
		
		<!-- Comprobar logueo -->
		<script>
			if (sessionStorage.sesion == undefined || sessionStorage.correo == undefined) {
				window.location.replace("login.html");
			}
		</script>
		<!-- Comprobar logueo -->
		
		<!-- JQuery -->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		<!-- JQuery -->
		
		<title>Gestión de Usuarios - Consulta</title>
	</head>
	
	<body>
		<header>
			<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
				<a class="navbar-brand" href="index.html">Gestión de Usuarios</a>
				<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
					<span class="navbar-toggler-icon"></span>
				</button>
				<div class="collapse navbar-collapse" id="navbarCollapse">
					<ul class="navbar-nav">
						<li class="nav-item">
							<a class="nav-link" href="index.html">Inicio</a>
						</li>
						<li class="nav-item">
							<a class="nav-link" href="alta.html">Dar de Alta</a>
						</li>
						<li class="nav-item">
							<a class="nav-link" href="baja.html">Dar de Baja</a>
						</li>
						<li class="nav-item active">
							<a class="nav-link" href="#">Consultar Usuarios<span class="sr-only">(current)</span></a>
						</li>
						<li class="nav-item">
							<a class="nav-link" href="modificar.html">Modificar Usuarios</a>
						</li>
					</ul>
					<ul class="navbar-nav ml-auto">
						<li class="nav-item">
							<button class="btn btn-primary float-right" onclick="cerrarSesion()">Cerrar Sesión
								<img src="icons/logout.png"><!--<div>Icons made by <a href="https://www.flaticon.com/authors/smashicons" title="Smashicons">Smashicons</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a> is licensed by <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0" target="_blank">CC 3.0 BY</a></div> -->
							</button>
						</li>
					</ul>
				</div>
			</nav>
		</header>
		
		<div class="container mb-4">
			<h2>Consultar Usuarios</h2>
			<p>
				Introduzca texto a buscar en la base de datos de usuarios junto con el campo deseado y pulse el botón de buscar. Si el campo de búsqueda se encuentra vacío, se mostrarán todos los usuarios.
				En caso de buscar un número de teléfono, deberá introducirlo con el respectivo código de país (ejemplo para España: +34012345678).
			</p>
			<div class="row">
				<div class="col">
					<form>
						<div class="form-group row">
							<label class="col-sm-2 col-form-label">Texto a buscar:</label>
							<div class="col-sm-10">
								<input type="text" class="form-control" id="txtBusqueda" placeholder="Introduzca texto...">
							</div>
						</div>
						<div class="form-group row">
							<label class="col-sm-2 col-form-label">Campo:</label>
							<div class="col-sm-10">
								<select class="form-control" id="cbCampoBusqueda">
									<option>Familia</option>
									<optgroup label="Tutor 1">
										<option>Nombre Tutor 1</option>
										<option>Apellido 1 Tutor 1</option>
										<option>Apellido 2 Tutor 1</option>
										<option>Tfno. Tutor 1</option>
										<option>Correo Tutor 1</option>
									</optgroup>
									<optgroup label="Tutor 2">
										<option>Nombre Tutor 2</option>
										<option>Apellido 1 Tutor 2</option>
										<option>Apellido 2 Tutor 2</option>
										<option>Tfno. Tutor 2</option>
										<option>Correo Tutor 2</option>
									</optgroup>
								</select>
							</div>
						</div>
						<button class="btn btn-primary" id="btnBuscar" onclick="buscarEnBBDD()" type="button">Buscar</button>
					</form>
				</div>
			</div>
		</div>
		
		<div class="container-fluid">
			<div class="row">				
				<div class="col">
					<table class="table table-bordered table-hover" id="tblResultados">
						<thead class="thead-light">
							<tr>
								<th class="text-center">
									#
								</th>
								<th class="text-center">
									Familia
								</th>
								<th class="text-center">
									Nombre Tutor 1
								</th>
								<th class="text-center">
									Nombre Tutor 2
								</th>
								<th class="text-center">
									Tfno. Tutor 1
								</th>
								<th class="text-center">
									Tfno. Tutor 2
								</th>
								<th class="text-center">
									Correo Tutor 1
								</th>
								<th class="text-center">
									Correo Tutor 2
								</th>
							</tr>
						</thead>
						<tbody>
							<tr id='addr0'>
								<td>
									1
								</td>
								<td>
									<input type="text" name="familia" id="familia1" placeholder="Nombre Familia" class="form-control" disabled/>
								</td>
								<td>
									<input type="text" name="nombreT1" id="nombreT11" placeholder="Nombre Tutor 1" class="form-control" disabled/>
								</td>
								<td>
									<input type="text" name="nombreT2" id="nombreT21" placeholder="Nombre Tutor 2" class="form-control" disabled/>
								</td>
								<td>
									<input type="text" name="tfnoT1" id="tfnoT11" placeholder="Tfno. Tutor 1" class="form-control" disabled/>
								</td>
								<td>
									<input type="text" name="tfnoT2" id="tfnoT21" placeholder="Tfno. Tutor 2" class="form-control" disabled/>
								</td>
								<td>
									<input type="text" name="correoT1" id="correoT11" placeholder="Correo Tutor 1" class="form-control" disabled/>
								</td>
								<td>
									<input type="text" name="correoT2" id="correoT21" placeholder="Correo Tutor 2" class="form-control" disabled/>
								</td>
							</tr>
		                    <tr id='addr1'>
								
		                    </tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>
		
		<script>
			var i = 1;
			
			function buscarEnBBDD() {
				var txtBusqueda = document.getElementById("txtBusqueda").value;
				var cbCampoBusqueda = document.getElementById("cbCampoBusqueda");
				var filtro = null;
				var myData = null;
				
				restaurarTabla();
				
				if (txtBusqueda == "") {
					firestore.collection("Usuarios").get().then(function(querySnapshot) {
					    querySnapshot.forEach(function(doc) {
					        myData = doc.data();
					        rellenarFila(doc.id, myData);
					        addFila();
					    });
					});
				} else {
					filtro = cbCampoBusqueda.options[cbCampoBusqueda.selectedIndex].text;
					buscarConFiltro(filtro, txtBusqueda);
				}
			}
			
			function rellenarFila(nombreFamilia, datos) {
				var familia = document.getElementById("familia" + i.toString());
				var nombreT1 = document.getElementById("nombreT1" + i.toString());
				var nombreT2 = document.getElementById("nombreT2" + i.toString());
				var tfnoT1 = document.getElementById("tfnoT1" + i.toString());
				var tfnoT2 = document.getElementById("tfnoT2" + i.toString());
				var correoT1 = document.getElementById("correoT1" + i.toString());
				var correoT2 = document.getElementById("correoT2" + i.toString());
				
				familia.value = nombreFamilia;
				nombreT1.value = datos.NombreTutor1 + " " + datos.Apellido1Tutor1 + " " + datos.Apellido2Tutor1;
				if (datos.NombreTutor2 != ""){
					nombreT2.value = datos.NombreTutor2 + " " + datos.Apellido1Tutor2 + " " + datos.Apellido2Tutor2;
				}
				tfnoT1.value = datos.TelefonoTutor1;
				tfnoT2.value = datos.TelefonoTutor2;
				correoT1.value = datos.CorreoTutor1;
				correoT2.value = datos.CorreoTutor2;
			}
			
			function addFila() {
				var numero = "<td>" + (i + 1) + "</td>";
				var familia = "<td><input type='text' name='familia' id='familia" + (i + 1) + "' placeholder='Nombre Familia' class='form-control' disabled /></td>";
				var nombreT1 = "<td><input type='text' name='nombreT1' id='nombreT1" + (i + 1) + "' placeholder='Nombre Tutor 1' class='form-control' disabled /></td>";
				var nombreT2 = "<td><input type='text' name='nombreT2' id='nombreT2" + (i + 1) + "' placeholder='Nombre Tutor 2' class='form-control' disabled /></td>";
				var tfnoT1 = "<td><input type='text' name='tfnoT1' id='tfnoT1" + (i + 1) + "' placeholder='Tfno. Tutor 1' class='form-control' disabled /></td>";
				var tfnoT2 = "<td><input type='text' name='tfnoT2' id='tfnoT2" + (i + 1) + "' placeholder='Tfno. Tutor 2' class='form-control' disabled /></td>";
				var correoT1 = "<td><input type='text' name='correoT1' id='correoT1" + (i + 1) + "' placeholder='Correo Tutor 1' class='form-control' disabled /></td>";
				var correoT2 = "<td><input type='text' name='correoT2' id='correoT2" + (i + 1) + "' placeholder='Correo Tutor 2' class='form-control' disabled /></td>";
				//var btnModificar = "<td><button class='btn btn-primary float-right' id='btnModificar" + (i + 1) + "' onclick='modificarUsuario(this.id)'>Modificar</button></td>";
				
				$('#addr' + i).html(numero + familia + nombreT1 + nombreT2 + tfnoT1 + tfnoT2 + correoT1 + correoT2);
				$('#tblResultados').append('<tr id="addr' + (i + 1) + '"></tr>');
				
				i++; 
			}
			
			function restaurarTabla() {
				var familia = document.getElementById("familia1");
				var nombreT1 = document.getElementById("nombreT11");
				var nombreT2 = document.getElementById("nombreT21");
				var tfnoT1 = document.getElementById("tfnoT11");
				var tfnoT2 = document.getElementById("tfnoT21");
				var correoT1 = document.getElementById("correoT11");
				var correoT2 = document.getElementById("correoT21");
				
				familia.value = "";
				nombreT1.value = "";
				nombreT2.value = "";
				tfnoT1.value = "";
				tfnoT2.value = "";
				correoT1.value = "";
				correoT2.value = "";
				
				while (i > 1) {
					$("#addr" + (i - 1)).html('');
					i--;
				}
			}
			
			function buscarConFiltro(filtro, txtBusqueda){
				var usuariosRef = firestore.collection("Usuarios");
				var campoConsulta = null;
				var consulta = null
				var myData = null;
				
				if (filtro == "Familia") {
					consulta = usuariosRef.doc(txtBusqueda);
					
					consulta.get().then(function(doc) {
					    if (doc.exists) {
					    		myData = doc.data();
					        rellenarFila(doc.id, myData);
					    } else {
					        alert("No se ha encontrado ningún usuario con los datos especificados.");
					    }
					}).catch(function(error) {
					    alert("Ha ocurrido un error en la comunicación con el servidor de base de datos.");
					});
				} else if (filtro == "Nombre Tutor 1") {
					campoConsulta = "NombreTutor1";
				} else if (filtro == "Apellido 1 Tutor 1") {
					campoConsulta = "Apellido1Tutor1";
				} else if (filtro == "Apellido 2 Tutor 1") {
					campoConsulta = "Apellido2Tutor1";
				} else if (filtro == "Nombre Tutor 2") {
					campoConsulta = "NombreTutor2";
				} else if (filtro == "Apellido 1 Tutor 2") {
					campoConsulta = "Apellido1Tutor1";
				} else if (filtro == "Apellido 2 Tutor 2") {
					campoConsulta = "Apellido1Tutor1";
				} else if (filtro == "Tfno. Tutor 1") {
					campoConsulta = "TelefonoTutor1";
				} else if (filtro == "Tfno. Tutor 2") {
					campoConsulta = "TelefonoTutor2";
				} else if (filtro == "Correo Tutor 1") {
					campoConsulta = "CorreoTutor1";
				} else if (filtro == "Correo Tutor 2") {
					campoConsulta = "CorreoTutor2";
				}
				
				if (campoConsulta != null){
					usuariosRef.where(campoConsulta, "==", txtBusqueda).get()
				    .then(function(querySnapshot) {
				        querySnapshot.forEach(function(doc) {
					    		myData = doc.data();
					        rellenarFila(doc.id, myData);
				        });
				    })
				    .catch(function(error) {
					    alert("Ha ocurrido un error en la comunicación con el servidor de base de datos.");
				    });
				}
				
			}
			
			/* function modificarUsuario(btnId) {
				var rowNumber = btnId.substring(12, btnId.length);
				var btnModificar = document.getElementById(btnId);
				
				var familia = document.getElementById("familia" + rowNumber);
				var nombreT1 = document.getElementById("nombreT1" + rowNumber);
				var nombreT2 = document.getElementById("nombreT2" + rowNumber);
				var tfnoT1 = document.getElementById("tfnoT1" + rowNumber);
				var tfnoT2 = document.getElementById("tfnoT2" + rowNumber);
				var correoT1 = document.getElementById("correoT1" + rowNumber);
				var correoT2 = document.getElementById("correoT2" + rowNumber);
				
				familia.disabled = false;
			} */
		</script>
		
		<script src="scripts/cerrarSesion.js"></script>
		
		<script src="scripts/conectarFirebase.js"></script>
	</body>

</html>